{% extends "./base.html" %}

{% load static %}

{% block content %}
<div class="container-fluid">
    <main class="pt-5">
        <div class="row g-3 align-items-center flex-nowrap flex-sm-wrap">

            <!-- Product Image -->
            <div class="col-4 col-sm-6 col-md-5 text-center">
                <img class="img-fluid" alt="{{ product.title }}"
                     src="{{ product.image.url }}"
                     style="width: 100%; max-height: 200px; object-fit: contain;">
            </div>

            <!-- Product Details -->
            <div class="col-8 col-sm-6 col-md-7">
                <h1 class="h6 mb-2">{{ product.title }}</h1>
                <strong>{{ product.brand }}</strong>

                <hr class="my-2">

                <p class="small">{{ product.description }}</p>

                <!-- Product Price and Quantity -->
                <div class="border rounded">
                    <!-- Price -->
                    <div class="border-bottom p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Price</span>
                            <span class="h6 fw-bold">Kshs. {{ product.price }}</span>
                        </div>
                    </div>

                    <!-- Quantity and Add to Cart -->
                    <div class="p-2">
                        <div class="row g-2 align-items-center">
                            <!-- Quantity Dropdown -->
                            <div class="col-6">
                                <label for="select" class="form-label small">Qty</label>
                                <select id="select" class="form-select form-select-sm">
                                {% for i in quantity_range %}
                                    <option value="{{ i }}">{{ i }}</option>
                                {% empty %}
                                    <option value="0" disabled>Out of Stock</option>
                                {% endfor %}
                                </select>
                            </div>

                            <!-- Stock Available -->
                            <div class="col-6">
                                <span class="small text-muted">Stock Available: {{ product.stock }}</span>
                            </div>

                            <!-- Add to Cart Button -->
                            <div class="col-12 text-end mt-2">
                                <button type="button" id="add-button" value="{{ product.id }}"
                                        class="btn btn-secondary btn-sm w-100" {% if product.stock == 0 %} disabled {% endif %}>
                                    Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<!-- JavaScript -->
<script>
    $(document).ready(function() {
        // Update the Add to Cart button and quantity options based on available stock
        const stockAvailable = {{ product.stock }};
        const quantitySelect = $('#select');
        const addButton = $('#add-button');

        // Disable quantity options exceeding stock
        if (stockAvailable === 0) {
            addButton.prop('disabled', true);  // Disable the button if no stock is available
        }

        // Enable or disable the Add to Cart button based on selected quantity
        quantitySelect.on('change', function() {
            const selectedQuantity = parseInt($(this).val());
            if (selectedQuantity > stockAvailable) {
                addButton.prop('disabled', true);
            } else {
                addButton.prop('disabled', false);
            }
        });

        // Add product to cart
        $(document).on('click', '#add-button', function(e) {
            e.preventDefault();
            $.ajax({
                type: 'POST',
                url: '{% url "cart-add" %}',
                data: {
                    product_id: $('#add-button').val(),
                    product_quantity: $('#select option:selected').val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    action: 'post'
                },
                success: function(json) {
                    document.getElementById('cart-qty').textContent = json.qty;
                },
                error: function(xhr, errmsh, err) {
                    console.error("Error adding product to cart:", errmsh);
                }
            });
        });
    });
</script>
{% endblock %}