{% extends "store/base.html" %}
{% load static %}
{% load mathfilters %}

{% block content %}
<main class="pt-5">
    <div class="container">
        <h1 class="h5">Shopping Cart Summary</h1>
        <hr>

        <!-- Cart Table -->
        <div class="table-responsive">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">Image</th>
                        <th scope="col">Product</th>
                        <th scope="col">Price</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Total</th>
                        <th scope="col">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart %}
                    {% with product=item.product %}
                    <tr>
                        <td class="text-center">
                            <img 
                                src="{{ product.image.url }}" 
                                alt="{{ product.title }}" 
                                class="img-fluid" 
                                style="max-width: 100px; max-height: 100px; object-fit: contain;">
                        </td>
                        <td>
                            <a href="{{ product.get_absolute_url }}" class="text-decoration-none text-reset">
                                {{ product.title }}
                            </a>
                        </td>
                        <td>Kshs. {{ product.price }}</td>
                        <td>
                            <select class="form-select form-select-sm" id="select-{{ product.id }}">
                                <option value="1" {% if item.qty == 1 %}selected{% endif %}>1</option>
                                <option value="2" {% if item.qty == 2 %}selected{% endif %}>2</option>
                                <option value="3" {% if item.qty == 3 %}selected{% endif %}>3</option>
                                <option value="4" {% if item.qty == 4 %}selected{% endif %}>4</option>
                            </select>
                        </td>
                        <td>Kshs. {{ product.price|mul:item.qty }}</td>
                        <td>
                            <button type="button" class="btn btn-primary btn-sm update-button" data-index="{{ product.id }}">
                                Update
                            </button>
                            <button type="button" class="btn btn-danger btn-sm delete-button" data-index="{{ product.id }}">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Summary -->
        <div class="text-end">
            <p class="h6 fw-bold">Subtotal: Kshs. <span id="total">{{ cart.get_total }}</span></p>
            <a href="{% url 'checkout' %}" class="btn btn-primary">Proceed to Checkout</a>
        </div>
    </div>
</main>

<!-- JavaScript -->
<script>
$(document).ready(function() {
    // Update cart item quantity
    $(document).on('click', '.update-button', function(e) {
        e.preventDefault();
        const productId = $(this).data('index');
        const quantity = $('#select-' + productId).val();

        $.ajax({
            type: 'POST',
            url: '{% url "cart-update" %}',
            data: {
                product_id: productId,
                product_quantity: quantity,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(json) {
                alert('Cart updated successfully!');
                location.reload(); // Refresh the page to show updated totals
            },
            error: function() {
                alert('Error updating cart item.');
            }
        });
    });

    // Delete cart item
    $(document).on('click', '.delete-button', function(e) {
        e.preventDefault();
        const productId = $(this).data('index');

        $.ajax({
            type: 'POST',
            url: '{% url "cart-delete" %}',
            data: {
                product_id: productId,
                csrfmiddlewaretoken: '{{ csrf_token }}',
                action: 'post'
            },
            success: function(json) {
                alert('Item removed from cart!');
                location.reload(); // Refresh the page
            },
            error: function() {
                alert('Error removing item from cart.');
            }
        });
    });
});
</script>
{% endblock %}
