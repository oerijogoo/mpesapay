{% extends 'sms/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid">
    <!-- Filter Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-body">
                    <form id="dashboardFilters">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <select class="form-select" name="academic_year">
                                    <option value="">All Academic Years</option>
                                    {% for year in filters.academic_years %}
                                    <option value="{{ year.id }}">{{ year.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" name="course">
                                    <option value="">All Courses</option>
                                    {% for course in filters.courses %}
                                    <option value="{{ course.id }}">{{ course.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" name="semester">
                                    <option value="">All Semesters</option>
                                    {% for semester in filters.semesters %}
                                    <option value="{{ semester.id }}">{{ semester.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" name="subject">
                                    <option value="">All Subjects</option>
                                    {% for subject in filters.subjects %}
                                    <option value="{{ subject.id }}">{{ subject.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row">
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-body chart-container">
                    <h5 class="card-title">Grade Distribution</h5>
                    <canvas id="gradeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card shadow mb-4">
                <div class="card-body chart-container">
                    <h5 class="card-title">Course Enrollment</h5>
                    <canvas id="enrollmentChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-body chart-container">
                    <h5 class="card-title">Top Student Performance</h5>
                    <canvas id="performanceChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    let charts = {
        grade: null,
        enrollment: null,
        performance: null
    };

    // Chart configurations
    const chartConfigs = {
        grade: {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b']
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        },
        enrollment: {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Students',
                    data: [],
                    backgroundColor: '#4e73df'
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true } }
            }
        },
        performance: {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Average Score',
                    data: [],
                    backgroundColor: '#1cc88a'
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: { x: { beginAtZero: true } }
            }
        }
    };

    // Initialize charts
    function initCharts() {
        charts.grade = new Chart(
            document.getElementById('gradeChart'),
            chartConfigs.grade
        );
        charts.enrollment = new Chart(
            document.getElementById('enrollmentChart'),
            chartConfigs.enrollment
        );
        charts.performance = new Chart(
            document.getElementById('performanceChart'),
            chartConfigs.performance
        );
    }

    // Update charts with data
    function updateCharts(data) {
        // Grade Chart
        charts.grade.data.labels = data.grade_data.map(g => g.grade__grade);
        charts.grade.data.datasets[0].data = data.grade_data.map(g => g.count);
        charts.grade.update();

        // Enrollment Chart
        charts.enrollment.data.labels = data.enrollment_data.map(e => e.course__name);
        charts.enrollment.data.datasets[0].data = data.enrollment_data.map(e => e.total);
        charts.enrollment.update();

        // Performance Chart
        charts.performance.data.labels = data.performance_data.map(p => p.full_name);
        charts.performance.data.datasets[0].data = data.performance_data.map(p => p.avg_score);
        charts.performance.update();
    }

    // Load initial data
    initCharts();
    updateCharts({
        grade_data: JSON.parse('{{ grade_data|escapejs }}'),
        enrollment_data: JSON.parse('{{ enrollment_data|escapejs }}'),
        performance_data: JSON.parse('{{ performance_data|escapejs }}')
    });

    // Filter handler
    document.getElementById('dashboardFilters').addEventListener('change', async () => {
        try {
            document.body.classList.add('loading');
            const params = new URLSearchParams(new FormData(document.getElementById('dashboardFilters')));
            const response = await fetch(`{% url 'sms:filter_data' %}?${params}`);

            if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
            const data = await response.json();

            updateCharts(data);
        } catch (error) {
            console.error('Filter Error:', error);
            alert(`Error: ${error.message}`);
        } finally {
            document.body.classList.remove('loading');
        }
    });
});
</script>

<style>
.chart-container {
    position: relative;
    height: 400px;
    min-height: 300px;
}

.loading::after {
    content: "Loading...";
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 1rem 2rem;
    border-radius: 5px;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
    z-index: 1000;
}
</style>
{% endblock %}